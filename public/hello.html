<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hello World</title>
</head>
<body>
  <h1>Hello World</h1>
  <!-- Custom module loader, no require.js -->
  <script>
    window.context = {
      register: function(ctx) {
        window._module = ctx;
      }
    };
    // Custom define implementation that passes window.context as parameter
    window._module = {};
    window.define = function(name, factory) {
      factory(window.context);
    };
  </script>
  <script>
    define('iframeContext', function(context) {
      const self = {
        typeIdentifier: 'iframeContext1',
        getInstance: function() {
          console.log('Getting instance of iframe context');
          return self;
        },
        getResponse: function() {
          return 'This is a response from the iframe context.';
        },
        getState: function() {
          return { status: 'active' };
        },
        oncompleted: function(callback) {
          setTimeout(callback, 1000); // Simulate async completion
        }
      };
      if (context) {
        context.register(self);
      }
      return self;
    });
  </script>
  <script>
    // Direct usage of iframeContext
    window.addEventListener('message', function(event) {
      if (!event.data || !event.data.type) return;
      const iframeContext = window._module;
      if (event.data.type === 'validateApi') {
        const methods = Object.keys(iframeContext).filter(fn => typeof iframeContext[fn] === 'function');
        event.source.postMessage({ type: 'api', methods }, event.origin);
      } else if (event.data.type === 'call') {
        const { fnName, args } = event.data;
        let result = null;
        if (typeof iframeContext[fnName] === 'function') {
          result = iframeContext[fnName](...(args || []));
        }
        event.source.postMessage({ type: 'callResult', result }, event.origin);
      }
    });
  </script>
</body>
</html>
